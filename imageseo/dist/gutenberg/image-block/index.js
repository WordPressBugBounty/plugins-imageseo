(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};window.React;const t=window.wp.components,r=window.wp.blockEditor,a=window.wp.data,i=window.wp.compose,n=window.wp.apiFetch;var o=e.n(n);const s=async e=>{try{return await o()({path:"imageseo/v1/generate-alt-text/",method:"POST",data:e})}catch(e){console.error("Error calling the api:",e)}},l=async e=>{console.log(e);try{const t=await fetch(e.url,{method:"HEAD",cache:"no-store"});return console.log(t?.status),404===t.status?await o()({path:"imageseo/v1/check-image/",method:"POST",data:e}):{}}catch(t){console.log(t);try{return await o()({path:"imageseo/v1/check-image/",method:"POST",data:e})}catch(e){return console.error("Error checking image:",e),{error:e.message}}}},c=window.wp.i18n,g=window.wp.element,u="imageseo-url-check",m=(0,i.createHigherOrderComponent)((e=>i=>{const[n,o]=(0,g.useState)(!1),m=(0,g.useRef)(i.attributes.url),{setError:d}=(0,a.useDispatch)("imageseo"),{lockPostSaving:p,unlockPostSaving:w,savePost:h}=(0,a.useDispatch)("core/editor"),E=(0,g.useRef)(null);if("core/image"!==i.name)return React.createElement(e,i);const{error:b}=(0,a.useSelect)((e=>({error:e("imageseo").getError()})),[]),{updateBlockAttributes:y}=(0,a.useDispatch)("core/block-editor"),{isSavingPost:f,isAutosaving:k}=(0,a.useSelect)((e=>({isSavingPost:e("core/editor").isSavingPost(),isAutosaving:e("core/editor").isAutosavingPost()}))),R=window?.imageSEO||{},_="true"===R.rewriteFilename||"1"===R.rewriteFilename||1===R.rewriteFilename||!0===R.rewriteFilename,v=(0,g.useCallback)((async()=>{const{url:e,id:t}=i.attributes;if(!e||!_)return!1;if(E.current===e)return!1;try{o(!0);const r=await l({id:t,url:e});if(r.error)return!1;if(r.url||r.altText){const t={};if(r.url&&r.url!==e&&(t.url=r.url),r.altText&&r.altText!==i.attributes.alt&&(t.alt=r.altText),Object.keys(t).length>0)return y(i.clientId,t),E.current=t.url||e,!0}return!1}catch(e){return console.error("Error checking URL on save:",e),d(e.message),!1}finally{o(!1)}}),[i.attributes,i.clientId,d,_,y]);return(0,g.useEffect)((()=>{(async()=>{if(f&&!k){p(u);const e=await v();w(u),e&&setTimeout((()=>{h()}),100)}})()}),[f,k,v,p,w,h]),(0,g.useEffect)((()=>{const{url:e}=i.attributes;e!==m.current&&(v(),m.current=e)}),[v,i.attributes,i.attributes.url]),React.createElement(React.Fragment,null,React.createElement(e,i),React.createElement(r.InspectorControls,null,React.createElement("div",{className:"components-panel__body is-opened"},b?React.createElement("div",{className:"error"},"ImageSEO Error: ",b):React.createElement(t.Button,{isPrimary:!0,onClick:async()=>{o(!0);const{id:e,url:t}=i.attributes,r=await s({id:e,url:t});r.error&&d(r.error),o(!1),y(i.clientId,{alt:r.altText})},className:"components-button editor-post-featured-image__toggle",isBusy:n},(0,c.__)("Generate alt with ImageSEO","imageseo")))))}),"withImageAltButton"),d=window.wp.editPost,p=window.wp.plugins,w=()=>{const{updateBlockAttributes:e}=(0,a.useDispatch)("core/block-editor"),{updateSettings:r,setUpdating:i,setError:n}=(0,a.useDispatch)("imageseo"),{settings:o,isUpdating:g,error:u}=(0,a.useSelect)((e=>({settings:e("imageseo").getSettings(),isUpdating:e("imageseo").isUpdating(),error:e("imageseo").getError()})),[]),{totalImages:m,imagesWithAlt:d,percentage:p,imageBlocks:w}=(0,a.useSelect)((e=>{const{getClientIdsWithDescendants:t,getBlock:r}=e("core/block-editor"),a=t().map((e=>r(e))).filter((e=>"core/image"===e.name)),i=a.length,n=a.filter((e=>e.attributes.alt&&""!==e.attributes.alt.trim())).length;return{totalImages:i,imagesWithAlt:n,percentage:i>0?Math.round(n/i*100):0,imageBlocks:a}}),[]);return React.createElement("div",{className:"imageseo-panel-content"},React.createElement("p",{className:"description"},(0,c.__)("Add alt text from your media library to images. For images without alt text, new descriptions will be automatically generated.","imageseo")),React.createElement("div",{className:"alt-text-stats"},m>0?React.createElement("p",null,(0,c.__)("Alt Text","imageseo")," ",React.createElement("strong",null,d,"/",m," ",(0,c.__)("images","imageseo")," (",p,"%)")):React.createElement("p",null,(0,c.__)("No images found in the content","imageseo"))),React.createElement(t.CheckboxControl,{label:(0,c.__)("Overwrite existing alt text","imageseo"),checked:o.overwriteExisting,onChange:e=>r({overwriteExisting:e})}),React.createElement(t.CheckboxControl,{label:(0,c.__)("Include images not in library","imageseo"),checked:o.includeNonLibrary,onChange:e=>r({includeNonLibrary:e})}),u?React.createElement("div",{className:"error"},"ImageSEO Error: ",u):React.createElement("div",{className:"imageseo-buttons"},React.createElement(t.Button,{variant:"secondary",className:"refresh-alt-text-button",onClick:async()=>{i(!0);try{const t=4;for(let r=0;r<w.length;r+=t){const a=w.slice(r,r+t);await Promise.all(a.map((async t=>{const{id:r,url:a}=t.attributes;if(!o.overwriteExisting&&t.attributes.alt?.trim())return;if(!o.includeNonLibrary&&!r)return;const i=await s({id:r,url:a});if(i.error)return n(i.error),void console.warn(`Error generating alt text for image ${r||a}:`,i.error);e(t.clientId,{alt:i.altText})})))}}catch(e){n(e),console.error("Error updating alt text:",e)}finally{i(!1)}},isBusy:g,disabled:g,icon:"update"},g?(0,c.__)("Updating all alts…","imageseo"):(0,c.__)("Update all alts","imageseo")),React.createElement(t.Button,{variant:"secondary",className:"check-urls-button",onClick:async()=>{i(!0);try{const t=2;for(let r=0;r<w.length;r+=t){const a=w.slice(r,r+t);await Promise.all(a.map((async t=>{const{id:r,url:a}=t.attributes;if(!a)return;console.log("Checking image:",{id:r,url:a});const i=await l({id:r,url:a});if(console.log("Check result:",i),i.error)console.warn(`Error checking image ${r||a}:`,i.error);else if(i.url||i.alt){const r={};i.url&&i.url!==t.attributes.url&&(r.url=i.url),i.alt&&i.alt!==t.attributes.alt&&(r.alt=i.alt),Object.keys(r).length>0&&(console.log("Updating block:",t.clientId,r),e(t.clientId,r))}})))}}catch(e){n(e),console.error("Error checking URLs:",e)}finally{i(!1)}},isBusy:g,disabled:g,icon:"search"},g?(0,c.__)("Checking URLs…","imageseo"):(0,c.__)("Check & Fix URLs","imageseo"))))},h={settings:{overwriteExisting:!1,includeNonLibrary:!1},isUpdating:!1,error:null},E=(0,a.createReduxStore)("imageseo",{reducer(e=h,t){switch(t.type){case"UPDATE_SETTINGS":return{...e,settings:{...e.settings,...t.settings}};case"SET_UPDATING":return{...e,isUpdating:t.isUpdating};case"SET_ERROR":return{...e,error:t.error};default:return e}},actions:{updateSettings:e=>({type:"UPDATE_SETTINGS",settings:e}),setUpdating:e=>({type:"SET_UPDATING",isUpdating:e}),setError:e=>({type:"SET_ERROR",error:e})},selectors:{getSettings:e=>e.settings,isUpdating:e=>e.isUpdating,getError:e=>e.error}});(0,a.register)(E),window.addEventListener("DOMContentLoaded",(()=>{wp.hooks.addFilter("editor.BlockEdit","imageseo/with-image-alt-button",m),(0,p.registerPlugin)("imageseo-settings",{render:()=>React.createElement(d.PluginDocumentSettingPanel,{name:"imageseo-panel",title:(0,c.__)("Image SEO","imageseo"),className:"imageseo-panel"},React.createElement(w,null)),icon:"format-image"})}))})();